@{
    ViewData["Title"] = "Upload Photo - Student Connect";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="~/css/cut-theme.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: var(--cut-light-gray);
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .option-btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--cut-navy) 0%, var(--cut-blue) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            font-size: 1rem;
        }

        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 67, 120, 0.3);
        }

        .option-btn input[type="file"] {
            display: none;
        }

        #cameraContainer {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        #camera {
            width: 100%;
            max-width: 400px;
            border: 3px solid var(--cut-blue);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #photoPreview {
            width: 100px;
            max-width: 400px; /* makes it a square */
            height:400px;
            object-fit:contain ; /* ensures image fills the box neatly */
            border: 3px solid var(--cut-blue);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin: 15px auto 0 auto;
            display: block;
            background: #f9f9f9;
        }

        .upload-btn {
            background: var(--cut-orange);
            font-size: 1.1rem;
            padding: 15px 50px;
        }

        .upload-btn:hover {
            background: #d35400;
        }

        .instructions {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid var(--cut-blue);
        }

        .instructions h4 {
            color: var(--cut-navy);
            margin-top: 0;
        }

        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
            color: var(--cut-gray);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="cut-header">
        <div class="cut-header-container">
            <div class="cut-logo-section">
                <img src="~/images/cut-logo.png" alt="CUT Logo" class="cut-logo" />
                <div class="cut-header-text">
                    <h1>Student Connect+</h1>
                    <p style="font-size: 1.4rem; margin-top: 10px; font-weight: 500; color: white;">Photo Upload Portal</p>
                </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <a asp-action="StudentConnect" asp-controller="Home"
                   style="font-size: 18px; padding: 10px 15px; display: inline-flex; align-items: center; gap: 6px; color: white; border-radius: 6px; text-decoration: none;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 6px; font-size: 24px;">arrow_back</span>
                    Back to DashBoard
                </a>

                <a asp-action="LogOut" asp-controller="Home"
                   style="font-size: 18px; padding: 10px 15px; display: inline-flex; align-items: center; gap: 6px; color: white; border-radius: 6px; text-decoration: none;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 6px; font-size: 24px;">logout</span>
                    Logout
                </a>
            </div>

            </div>
        </div>
   

    <!-- Main Content -->
    <div class="cut-container" style="padding-top: 30px;">
        <div class="cut-card cut-card-large">
            <h3>Upload Student Card Photo</h3>

            <!-- Instructions -->
            <div class="instructions">
                <h4>
                    <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">info</span>
                    Photo Requirements
                </h4>
                <ul>
                    <li>Use a clear, recent photo of yourself</li>
                    <li>Ensure good lighting and a plain background</li>
                    <li>Face the camera directly with a neutral expression</li>
                    <li>Photo should be in JPEG or PNG format</li>
                    <li>Maximum file size: 5MB</li>
                </ul>
            </div>

            <!-- Upload Form -->
            <div class="upload-section">
                <form asp-action="UploadPhoto" method="post" enctype="multipart/form-data" style="text-align: center;">

                    <!-- Choose from Gallery -->
                    <label class="option-btn">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">photo_library</span>
                        Choose from Gallery
                        <input type="file" name="photo" accept="image/*" id="galleryInput">
                    </label>

                    <!-- Use Camera -->
                    <label class="option-btn" id="useCameraBtn" style="cursor:pointer;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">camera_alt</span>
                        Use Camera
                    </label>

                    <!-- Live Camera Capture -->
                    <div id="cameraContainer" style="display:none; text-align:center;">
                        <video id="camera" autoplay playsinline></video>
                        <br />
                        <canvas id="snapshot" style="display:none;"></canvas>
                        <input type="hidden" name="photoData" id="photoData" />

                        <button id="captureBtn" type="button" class="option-btn" style="margin-top:15px;">
                            <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">photo_camera</span>
                            Capture Photo
                        </button>
                    </div>

                    <!-- Preview Image -->
                    <div id="previewContainer" style="margin: 30px 0; text-align:center;">
                        <strong style="color: var(--cut-navy); font-size: 1.1rem;">Photo Preview:</strong>
                        <br />
                        <img id="photoPreview" src="" alt="Preview will appear here" style="display:none; width:100%;" />
                    </div>

                    <button type="submit" class="option-btn">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">cloud_upload</span>
                        Upload Photo
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="cut-footer">
        <p>&copy; @DateTime.Now.Year Central University of Technology</p>
        <p>Bloemfontein Campus | Student Number: @ViewBag.StudentNumber</p>
    </div>

    <script>
        const galleryInput = document.getElementById('galleryInput');
        const photoPreview = document.getElementById('photoPreview');
        const photoData = document.getElementById('photoData');

        // Gallery preview
        galleryInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoPreview.src = e.target.result;
                    photoPreview.style.display = 'block';
                    photoData.value = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Camera
        document.getElementById('useCameraBtn').addEventListener('click', async () => {
            const cameraContainer = document.getElementById('cameraContainer');
            cameraContainer.style.display = 'block';

            const video = document.getElementById('camera');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
            } catch (err) {
                console.error('Camera access failed:', err);
                alert('Cannot access camera. Please check permissions.');
            }
        });

        // Capture from camera
               document.getElementById('captureBtn').addEventListener('click', () => {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('snapshot');

            const size = 400; // square size
            canvas.width = size;
            canvas.height = size;

            const ctx = canvas.getContext('2d');
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            const minDim = Math.min(videoWidth, videoHeight);

            // crop center of video feed
            const sx = (videoWidth - minDim) / 2;
            const sy = (videoHeight - minDim) / 2;

            ctx.drawImage(video, sx, sy, minDim, minDim, 0, 0, size, size);

            const dataURL = canvas.toDataURL('image/png');
            photoPreview.src = dataURL;
            photoPreview.style.display = 'block';
            photoData.value = dataURL;

            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            document.getElementById('cameraContainer').style.display = 'none';
            alert('Photo captured successfully! Click "Upload Photo" to submit.');
        });

    </script>
</body>
</html>
