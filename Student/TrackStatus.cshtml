@{
    ViewData["Title"] = "Track Status - Student Connect";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="~/css/cut-theme.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
        /* REPLACE ONLY THE <style> SECTION IN YOUR CODE WITH THIS */

        body {
            margin: 0;
            padding: 0;
            background-color: var(--cut-light-gray);
        }

        .student-status-dashboard {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .card-status {
            background: white;
            border-radius: 12px;
            padding: 35px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 20px 0;

        }

        .card-header h2 {
            color: #0052a3;
            margin-bottom: 15px;
            font-size: 26px;
            font-weight: 600;
        }

        .card-header p {
            margin: 10px 0;
            color: #666;
            font-size: 14px;
        }

            .card-header p span {
                font-weight: 600;
                color: #333;
            }

        .progress-wrapper {
            position: relative;
            margin: 40px 0;
            padding: 30px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #0052a3;
        }
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: color: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 30px;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: #555;
            transition: width 1s ease-in-out, background 0.5s ease-in-out;
            border-radius: 4px;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            width: 100%;
        }

        .step {
            text-align: center;
            flex: 1;
            position: relative;
            font-size: 13px;
            color: #888;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 8px;
        }

            .step span {
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 auto 10px auto;
                width: 36px;
                height: 36px;
                line-height: 36px;
                border-radius: 50%;
                background: #ccc;
                color: white;
                font-weight: bold;
                transition: all 0.3s ease;
                font-size: 16px;
            }

        /* Active step colors */
        #step-photo.active span {
            background-color: #2196f3;
            box-shadow: 0 0 0 8px rgba(33, 150, 243, 0.15);
        }

        #step-review.active span {
            background-color: #ff9800;
            box-shadow: 0 0 0 8px rgba(255, 152, 0, 0.15);
        }

        #step-production.active span {
            background-color: #9c27b0;
            box-shadow: 0 0 0 8px rgba(156, 39, 176, 0.15);
        }

        #step-ready.active span {
            background-color: #4caf50;
            box-shadow: 0 0 0 8px rgba(76, 175, 80, 0.15);
        }

        /* Completed steps - all green */
        #step-photo.completed span,
        #step-review.completed span,
        #step-production.completed span,
        #step-ready.completed span {
            background-color: dimgrey;
        }

        .step.active {
            font-weight: 700;
            color: #333;
        }

        .step.completed {
            color: dimgrey;
            font-weight: 700;
        }

        .notifications, .need-help {
            margin-top: 25px;
            padding: 18px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #0052a3;
        }

        .need-help {
            border-left-color: #0052a3;
        }

            .notifications h4, .need-help h4 {
                margin-top: 0;
                margin-bottom: 12px;
                color: #333;
                font-size: 14px;
                font-weight: 600;
            }

        .notifications label {
            display: block;
            margin: 10px 0;
            color: #555;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notifications input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #2196f3;
        }

        .need-help p {
            margin: 0;
            font-size: 16px;
            color: #2196f3;
            font-weight: bold;
        }

        #connectionStatus {
            display: inline-block;
            font-weight: 600;
            padding: 4px 10px;
            background: #e8f5e9;
            border-radius: 4px;
            color: #2e7d32;
            font-size: 13px;
        }

        #debug-info {
            display: none;
            font-family: monospace;
            line-height: 1.4;
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 12px;
        }

        #connectionStatus {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="cut-header">
        <div class="cut-header-container">
            <div class="cut-logo-section">
                <img src="~/images/cut-logo.png" alt="CUT Logo" class="cut-logo" />
                <div class="cut-header-text">
                    <h1>Student Connect+</h1>
                    <p style="font-size: 1.4rem; margin-top: 10px; font-weight: 500; color: white;">Track Application Status</p>
                </div>
            </div>
            <div class="cut-nav">
                <a asp-action="StudentConnect" asp-controller="Home" style="font-size: 18px; padding: 10px 15px; display: inline-flex; align-items: center; gap: 6px;  color: white; border-radius: 6px; text-decoration: none;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 6px; font-size: 24px;">arrow_back</span>
                    Back to Dashboard
                </a>

                <a asp-action="LogOut" asp-controller="Home"
                   style="font-size: 18px; padding: 10px 15px; display: inline-flex; align-items: center; gap: 6px; color: white; border-radius: 6px; text-decoration: none; margin-left: 12px;">
                    <span class="material-icons" style="vertical-align: middle; margin-right: 6px; font-size: 24px;">logout</span>
                    Logout
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="student-status-dashboard">
        <div class="card-status">
            <div class="card-header">
                <h2>Application Status</h2>
                <p>Submitted: <span id="submissionDate">Loading...</span></p>
                <p>Last Updated: <span id="lastUpdated">Never</span></p>
                <p style="display:none;">Connection Status: <span id="connectionStatus">Connecting...</span></p>

            </div>

            <div class="card-body">
                <h4>Application Progress</h4>
                <div class="progress-wrapper">
                    <div class="steps">
                        <div class="step" id="step-photo"><span>1</span> Photo Submitted</div>
                        <div class="step" id="step-review"><span>2</span> Under Review</div>
                        <div class="step" id="step-production"><span>3</span> Card Production</div>
                        <div class="step" id="step-ready"><span>4</span> Ready for Collection</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>

                <div id="debug-info">
                    <strong>Debug Info:</strong><br>
                    Student Number: <span id="debug-student-number">@ViewBag.StudentId</span><br>
                    Current Status: <span id="debug-current-status">Loading...</span><br>
                    Raw Status: <span id="debug-raw-status">Loading...</span><br>
                    Firebase Connected: <span id="debug-firebase-connected">Checking...</span>
                </div>
            </div>

            <div class="notifications">
                <h4>Notification Preferences</h4>
                <label>Email Notifications <input type="checkbox" checked /></label>
               
                <label>Push Notifications <input type="checkbox" checked /></label>
            </div>

            <div class="need-help">
                <h4>Need Help?</h4>
                <p>📞 +27 51 507 3911</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="cut-footer">
        <p>&copy; @DateTime.Now.Year Central University of Technology</p>
        <p>Bloemfontein Campus | Student Connect System</p>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCLgrVbwCc1tx2o4_sssp_0Al1rhILlkK8",
            authDomain: "studentconnect-693f9.firebaseapp.com",
            databaseURL: "https://studentconnect-693f9-default-rtdb.firebaseio.com",
            projectId: "studentconnect-693f9",
            storageBucket: "studentconnect-693f9.firebasestorage.app",
            messagingSenderId: "937953702973",
            appId: "1:937953702973:web:33ce99c2c75cc2e0dd2654",
            measurementId: "G-600N3LRF6R"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const studentNum = '@ViewBag.StudentId';
        const submissionDateEl = document.getElementById("submissionDate");
        const lastUpdatedEl = document.getElementById("lastUpdated");
        const connectionStatusEl = document.getElementById("connectionStatus");
        const progressBar = document.getElementById("progress-bar");

        const debugCurrentStatusEl = document.getElementById("debug-current-status");
        const debugRawStatusEl = document.getElementById("debug-raw-status");
        const debugFirebaseConnectedEl = document.getElementById("debug-firebase-connected");

        const steps = [
            document.getElementById("step-photo"),
            document.getElementById("step-review"),
            document.getElementById("step-production"),
            document.getElementById("step-ready")
        ];

        const statusMap = {
            "photosubmitted": { percent: 25, index: 0, name: "Photo Submitted", color: "#2196f3" },
            "underreview": { percent: 50, index: 1, name: "Under Review", color: "#ff9800" },
            "cardproduction": { percent: 75, index: 2, name: "Card Production", color: "#9c27b0" },
            "readyforcollection": { percent: 100, index: 3, name: "Ready for Collection", color: "#4caf50" }
        };

        function updateConnectionStatus(connected) {
            connectionStatusEl.textContent = connected ? "🟢 Connected" : "🔴 Disconnected";
            connectionStatusEl.style.color = connected ? "green" : "red";
            debugFirebaseConnectedEl.textContent = connected ? "Yes" : "No";
        }

        function updateLastUpdated() {
            const now = new Date();
            lastUpdatedEl.textContent = now.toLocaleTimeString();
        }

        function updateStudentStatus(studentData) {
            updateLastUpdated();
            submissionDateEl.textContent = studentData.SubmissionDate ? new Date(studentData.SubmissionDate).toLocaleDateString() : "N/A";

            const rawStatus = (studentData.Status || "").replace(/\s+/g, '').toLowerCase();
            debugRawStatusEl.textContent = rawStatus;
            debugCurrentStatusEl.textContent = rawStatus;

            steps.forEach(step => step.classList.remove("active", "completed"));

            if (statusMap[rawStatus]) {
                progressBar.style.width = statusMap[rawStatus].percent + "%";
                progressBar.style.backgroundColor = statusMap[rawStatus].color;

                steps.forEach((step, idx) => {
                    if (idx < statusMap[rawStatus].index) step.classList.add("completed");
                    else if (idx === statusMap[rawStatus].index) step.classList.add("active");
                });
            } else {
                progressBar.style.width = "25%";
                steps[0].classList.add("active");
            }
        }

        function setupRealtimeListener() {
            const studentsRef = db.ref('StudentPhotos');

            studentsRef.on('value', (snapshot) => {
                const allStudents = snapshot.val();
                if (!allStudents) return;

                const foundStudent = Object.values(allStudents).find(s => s.StudentNumber === studentNum);
                if (foundStudent) updateStudentStatus(foundStudent);
            });

            studentsRef.on('child_changed', (snapshot) => {
                const studentData = snapshot.val();
                if (studentData && studentData.StudentNumber === studentNum) {
                    updateStudentStatus(studentData);
                }
            });
        }

        const connectedRef = db.ref('.info/connected');
        connectedRef.on('value', snapshot => updateConnectionStatus(snapshot.val() === true));

        setupRealtimeListener();
    </script>
</body>
</html>
